image: cirrusci/flutter:stable

stages:
  - test
  - build
  - deploy

variables:
  FLUTTER_CHANNEL: "stable"

before_script:
  - flutter --version
  - flutter pub get

# ------------------ TEST ------------------

test:
  stage: test
  script:
    - flutter test
  rules:
    - if: $CI_COMMIT_BRANCH

# ------------------ ANDROID ------------------

android_release:
  stage: deploy
  image: ruby:3.2
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apt-get update && apt-get install -y openjdk-17-jdk curl unzip
    - curl -s https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.19.0-stable.tar.xz | tar xJ
    - export PATH="$PATH:`pwd`/flutter/bin"
    - flutter pub get
    - gem install fastlane
    - echo "$PLAY_STORE_JSON_KEY" | base64 -d > android/play_store.json
  script:
    - cd android
    - fastlane release

# ------------------ iOS ------------------

ios_release:
  stage: deploy
  tags:
    - macos
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - flutter pub get
    - cd ios
    - gem install fastlane
    - fastlane release